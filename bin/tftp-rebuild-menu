#!/bin/bash

self=$(readlink -f "$0")
selfdir=$(dirname "$self")
source "${selfdir}/inc/require_root.sh"
source "${selfdir}/inc/read_config.sh"

################################################################################

tftpdir="${MIRROR_BASE_PATH}/tftp"
warning="# Do not edit this file.  It is autogenerated, and your changes will be overwritten.\n"

if [[ ! -d "$tftpdir" ]]; then
  echo "ERROR: tftp dir missing ($tftpdir)" >&2
  exit 1
fi

for i in vanilla custom troubleshooting
do
  menucfg="${tftpdir}/pxelinux.cfg/main-menu.cfg/${i}"
  autogen="${tftpdir}/pxelinux.cfg/autogenerated-menu-${i}"
  if [[ ! -f "${menucfg}.template" ]]; then
    echo "ERROR: '$i' menu template missing" >&2
    exit 1
  fi
  echo -e "$warning"        >  "$autogen"
  cat "${menucfg}".template >> "$autogen"
  cat "${menucfg}"*.cfg     >> "$autogen"
done
